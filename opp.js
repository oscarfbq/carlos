// =================================================================
// (NUEVO) MINI BASE DE DATOS DE PRODUCTOS
// =================================================================
// ¬°AQU√ç ES DONDE A√ëADIR√ÅS TODOS TUS PRODUCTOS!
// Solo copia y pega un bloque { ... }, y cambia los datos.
// Aseg√∫rate de poner la URL correcta de tu imagen.
// =================================================================
const baseDeDatos = {
    fruteria: [
        { 
            nombre: 'Aguacate', 
            precio: 35.00, 
            img: 'frutas/Aguacate.jpg' 
        },
        { 
            nombre: 'Albahaca', 
            precio: 18.00, 
            img: 'albhaca.jpg' 
        },
        { 
            nombre: 'Apio', 
            precio: 22.00, 
            img: 'apio.jpg' 
        },
        { 
            nombre: 'Ajo', 
            precio: 22.00, 
            img: 'ajo.jpg' 
        },
        { 
            nombre: 'Brocoli', 
            precio: 22.00, 
            img: 'brocoli.jpg' 
        },

         { 
            nombre: 'Calabaza italiana', 
            precio: 22.00, 
            img: 'calabaza italiana.jpg' 
        },
        { 
            nombre: 'cebolla.jpg', 
            precio: 22.00, 
            img: 'cebolla.jpg' 
        },
        { 
            nombre: 'Cebolla blanca grande', 
            precio: 22.00, 
            img: 'cebolla.jpg' 
        },
        { 
            nombre: 'Cebolla blanca mediana', 
            precio: 22.00, 
            img: 'cebolla.jpg' 
        },
        { 
            nombre: 'Cebolla cambray', 
            precio: 22.00, 
            img: 'cebolla cambray.jpg' 
        },
        { 
            nombre: 'Cebolla morada', 
            precio: 22.00, 
            img: 'cebolla morada.jpg' 
        },
        { 
            nombre: 'Champi√±√≥n', 
            precio: 22.00, 
            img: 'champinones.jpg' 
        },
        { 
            nombre: 'Chayote', 
            precio: 22.00, 
            img: 'chayote.jpg' 
        },
        { 
            nombre: 'Chile de √°rbol', 
            precio: 22.00, 
            img: 'chile de arbol.jpg' 
        },
        { 
            nombre: 'Chile guajillo', 
            precio: 22.00, 
            img: 'chile guajillo.jpg' 
        },
        { 
            nombre: 'Chile habanero', 
            precio: 22.00, 
            img: 'habanero.jpg' 
        },
        { 
            nombre: 'Chile jalape√±o', 
            precio: 22.00, 
            img: 'chile jalapeno.jpg' 
        },
        { 
            nombre: 'Chile morita', 
            precio: 22.00, 
            img: 'chile morita.jpg' 
        },
        { 
            nombre: 'Chile puya', 
            precio: 22.00, 
            img: 'chile puya.jpg' 
        },
        { 
            nombre: 'Chile serrano verde', 
            precio: 22.00, 
            img: 'chile serrano.jpg' 
        },
        { 
            nombre: 'Cilantro', 
            precio: 22.00, 
            img: 'cilantro.jpg' 
        },
        { 
            nombre: 'Col blanca', 
            precio: 22.00, 
            img: 'col-blanca.jpg' 
        },
        { 
            nombre: 'Col morada', 
            precio: 22.00, 
            img: 'col morada.jpg' 
        },
        { 
            nombre: 'Coliflor', 
            precio: 22.00, 
            img: 'ciliflor.jpg' 
        },
        { 
            nombre: 'Fresa', 
            precio: 22.00, 
            img: 'fresa.jpg' 
        },
        { 
            nombre: 'Hierbabuena', 
            precio: 22.00, 
            img: 'hierbabuena.jpg' 
        },
        { 
            nombre: 'J√≠cama', 
            precio: 22.00, 
            img: '' 
        },
        { 
            nombre: 'Jitomate bola', 
            precio: 22.00, 
            img: 'jitomate bola.jpg' 
        },
        { 
            nombre: 'Jitomate primera', 
            precio: 22.00, 
            img: 'jitomate primera.jpg' 
        },
        { 
            nombre: 'Jitomate segunda', 
            precio: 22.00, 
            img: 'jitomate segunda.jpg' 
        },
        { 
            nombre: 'Lechuga bola', 
            precio: 22.00, 
            img: 'lechuga bola.jpg' 
        },
        { 
            nombre: 'Lechugas finas', 
            precio: 22.00, 
            img: 'lechuga finas.jpg' 
        },
        { 
            nombre: 'Lim√≥n agrio grande', 
            precio: 22.00, 
            img: 'limon con semilla.jpg' 
        },
        { 
            nombre: 'Lim√≥n agrio mediano', 
            precio: 22.00, 
            img: 'limon con semilla.jpg' 
        },
        { 
            nombre: 'Lim√≥n sin semilla', 
            precio: 22.00, 
            img: 'limon sin semilla.jpg' 
     
        },
        { 
            nombre: 'Manzana golden', 
            precio: 22.00, 
            img: 'manzana goolden.jpg' 
        },
        { 
            nombre: 'Naranja amarilla', 
            precio: 22.00, 
            img: 'naranja amarilla.jpg' 
        },
        { 
            nombre: 'Naranja verde', 
            precio: 22.00, 
            img: 'naranja verde.jpg' 
        },
        { 
            nombre: 'Papa blanca', 
            precio: 22.00, 
            img: 'papa blanca.jpg' 
        },
        { 
            nombre: 'Pepinillo', 
            precio: 22.00, 
            img: 'pepinillos.jpg' 
        },
        { 
            nombre: 'Pepino', 
            precio: 22.00, 
            img: 'pepino.jpg' 
        },
        { 
            nombre: 'Pera', 
            precio: 22.00, 
            img: 'pera.jpg' 
        },
        { 
            nombre: 'Pimiento morr√≥n', 
            precio: 22.00, 
            img: 'morron.jpg' 
        },
        { 
            nombre: 'Poro', 
            precio: 22.00, 
            img: 'poro.jpg' 
        },
        { 
            nombre: 'R√°banos', 
            precio: 22.00, 
            img: 'rabanos.jpg' 
        },
        { 
            nombre: 'Sand√≠a personal', 
            precio: 22.00, 
            img: 'sandia perzonal.jpg' 
        },
        { 
            nombre: 'Tomate', 
            precio: 22.00, 
            img: 'tomate.jpg' 
        },
        { 
            nombre: 'Uva verde sin semilla', 
            precio: 22.00, 
            img: 'uva verde.jpg' 
        },
        { 
            nombre: 'Zanahoria', 
            precio: 22.00, 
            img: 'zanahoria.jpg' 
        },
        
        // ... Puedes a√±adir 50 productos m√°s aqu√≠ ...
        // { 
        //     nombre: 'Manzana Gala', 
        //     precio: 40.00, 
        //     img: 'https://url-de-tu-manzana.jpg' 
        // },
    ],
    carniceria: [
        // ... Aqu√≠ ir√≠an tus productos de carnicer√≠a en el futuro ...
        // { 
        //     nombre: 'Bistec de Res', 
        //     precio: 190.00, 
        //     img: 'https://url-de-tu-bistec.jpg' 
        // },
    ]
};


// =================================================================
// (NUEVA) FUNCI√ìN PARA CARGAR PRODUCTOS EN EL HTML
// =================================================================
function cargarProductos(productos, gridElementId) {
    const grid = document.getElementById(gridElementId);
    
    // Si no encuentra el grid (ej. 'grid-carniceria' a√∫n no existe), no hace nada
    if (!grid) {
        console.warn(`No se encontr√≥ el elemento con id: ${gridElementId}`);
        return; 
    }

    grid.innerHTML = ''; // Limpiamos el grid por si acaso

    // Recorremos la lista de productos
    productos.forEach(producto => {
        
        // Creamos el HTML para la tarjeta
        // Usamos los datos del objeto: producto.img, producto.nombre, producto.precio
        const tarjetaHTML = `
            <div class="producto-card">
                <img src="${producto.img}" alt="${producto.nombre}" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200?text=Imagen+no+disponible'">
                <h3>${producto.nombre}</h3>
                <p class="precio">$${producto.precio.toFixed(2)} / kg</p>
                
                <div class="kilo-selector">
                    <button type="button" class="btn-kilo btn-menos" aria-label="Disminuir">-</button>
                    <input class="kilo-input" type="text" value="1.0" readonly>
                    <button type="button" class="btn-kilo btn-mas" aria-label="Aumentar">+</button>
                    <span class="kilo-label">kg</span>
                </div>
                
                <button class="btn-compra" data-nombre="${producto.nombre}" data-precio="${producto.precio.toFixed(2)}">
                    A√±adir a la Cesta
                </button>
            </div>
        `;
        
        // A√±adimos la tarjeta al grid
        grid.innerHTML += tarjetaHTML;
    });
}


// =================================================================
// EL RESTO DE TU C√ìDIGO (CARRITO, WHATSAPP, ETC.)
// =================================================================

document.addEventListener('DOMContentLoaded', () => {

    // --- VARIABLES IMPORTANTES ---
    
    let carrito = {};

    // ¬°¬°¬°CAMBIA ESTE N√öMERO POR EL TUYO!!! (Incluyendo el 52 si es de M√©xico)
    const TU_NUMERO_DE_WHATSAPP = "524613267745"; // Ejemplo: "5214611234567"

    // Seleccionamos los elementos del DOM
    const listaCarrito = document.getElementById('lista-carrito');
    const totalPedido = document.getElementById('total-pedido');
    const carritoContador = document.getElementById('carrito-contador');
    const btnEnviarWhatsApp = document.getElementById('enviar-whatsapp');

    // Elementos para la factura
    const checkFactura = document.getElementById('requiere-factura');
    const datosFactura = document.getElementById('datos-factura');
    const inputRFC = document.getElementById('cliente-rfc');
    const inputRazonSocial = document.getElementById('cliente-razon-social');
    const inputUsoCFDI = document.getElementById('cliente-uso-cfdi');

    
    // --- (NUEVO) LLAMADA PARA CARGAR PRODUCTOS ---
    // Le decimos que cargue la lista 'fruteria' en el grid 'grid-fruteria'
    cargarProductos(baseDeDatos.fruteria, 'grid-fruteria');
    // (En el futuro, cargar√≠as los otros departamentos)
    // cargarProductos(baseDeDatos.carniceria, 'grid-carniceria');


    // --- FUNCIONES DEL CARRITO ---

    function manejarClicFruteria(evento) {
        const target = evento.target;
        if (target.classList.contains('btn-compra')) {
            anadirAlCarrito(target); 
        }
        if (target.classList.contains('btn-kilo')) {
            gestionarKilos(target); 
        }
    }
    
    // (Aqu√≠ necesitar√°s a√±adir listeners para los otros grids en el futuro)
    // document.getElementById('grid-carniceria').addEventListener('click', manejarClicFruteria);


    function gestionarKilos(boton) {
        const card = boton.closest('.producto-card');
        const input = card.querySelector('.kilo-input');
        let valor = parseFloat(input.value);

        if (boton.classList.contains('btn-mas')) {
            valor += 0.5;
        } else if (boton.classList.contains('btn-menos')) {
            valor -= 0.5;
        }

        if (valor < 0.5) {
            valor = 0.5;
        }
        input.value = valor.toFixed(1);
    }

    function anadirAlCarrito(boton) {
        const card = boton.closest('.producto-card');
        const nombre = boton.dataset.nombre;
        const precio = parseFloat(boton.dataset.precio);
        const kilos = parseFloat(card.querySelector('.kilo-input').value);

        if (kilos > 0) {
            if (carrito[nombre]) {
                carrito[nombre].kilos += kilos;
            } else {
                carrito[nombre] = {
                    precio: precio,
                    kilos: kilos
                };
            }
            actualizarCarritoUI();
        } else {
            alert("Por favor, selecciona una cantidad mayor a 0.");
        }
    }

    function actualizarCarritoUI() {
        listaCarrito.innerHTML = '';
        let total = 0;
        let numItems = 0;

        for (const nombre in carrito) {
            const item = carrito[nombre];
            const subtotal = item.precio * item.kilos;
            total += subtotal;
            numItems++; 

            const li = document.createElement('li');
            li.innerHTML = `
                <span>${nombre} (${item.kilos.toFixed(1)} kg) - $${subtotal.toFixed(2)}</span>
                <button class="btn-eliminar" data-nombre="${nombre}">√ó</button>
            `;
            listaCarrito.appendChild(li);
        }
        totalPedido.textContent = `Total: $${total.toFixed(2)}`;
        carritoContador.textContent = numItems;
    }

    function eliminarDelCarrito(evento) {
        if (evento.target.classList.contains('btn-eliminar')) {
            const nombre = evento.target.dataset.nombre;
            delete carrito[nombre];
            actualizarCarritoUI();
        }
    }

    function enviarPedidoWhatsApp() {
        const nombreCliente = document.getElementById('cliente-nombre').value;
        const telefonoCliente = document.getElementById('cliente-telefono').value;
        const direccionCliente = document.getElementById('cliente-direccion').value;

        if (!nombreCliente || !telefonoCliente || !direccionCliente) {
            alert("Por favor, completa tu Nombre, Tel√©fono y Direcci√≥n.");
            return;
        }

        let mensaje = `¬°Hola D'LCAMPO! üëã Quiero hacer un pedido:\n\n`;
        mensaje += `*Cliente:* ${nombreCliente}\n`;
        mensaje += `*Tel√©fono:* ${telefonoCliente}\n`;
        mensaje += `*Direcci√≥n:* ${direccionCliente}\n\n`;

        if (checkFactura.checked) {
            const rfc = inputRFC.value;
            const razonSocial = inputRazonSocial.value;
            const usoCFDI = inputUsoCFDI.value;

            if (!rfc || !razonSocial || !usoCFDI) {
                alert("Por favor, completa todos tus datos de facturaci√≥n (RFC, Raz√≥n Social y Uso de CFDI).");
                return;
            }
            
            mensaje += `*--- DATOS DE FACTURACI√ìN ---*\n`;
            mensaje += `*RFC:* ${rfc}\n`;
            mensaje += `*Raz√≥n Social:* ${razonSocial}\n`;
            mensaje += `*Uso de CFDI:* ${usoCFDI}\n\n`;
        }

        mensaje += `*MI PEDIDO:*\n`;
        let total = 0;
        
        if (Object.keys(carrito).length === 0) {
            alert("Tu carrito est√° vac√≠o. A√±ade productos antes de enviar.");
            return;
        }

        for (const nombre in carrito) {
            const item = carrito[nombre];
            const subtotal = item.precio * item.kilos;
            total += subtotal;
            mensaje += `- ${nombre} (${item.kilos.toFixed(1)} kg) - $${subtotal.toFixed(2)}\n`;
        }

        mensaje += `\n*TOTAL A PAGAR: $${total.toFixed(2)}*`;

        const mensajeCodificado = encodeURIComponent(mensaje);
        const urlWhatsApp = `https://api.whatsapp.com/send?phone=${TU_NUMERO_DE_WHATSAPP}&text=${mensajeCodificado}`;

        window.open(urlWhatsApp, '_blank');
    }

    function toggleCamposFactura() {
        if (checkFactura.checked) {
            datosFactura.style.display = 'block'; 
            inputRFC.required = true;
            inputRazonSocial.required = true;
            inputUsoCFDI.required = true;
        } else {
            datosFactura.style.display = 'none'; 
            inputRFC.required = false;
            inputRazonSocial.required = false;
            inputUsoCFDI.required = false;
        }
    }

    // --- EVENT LISTENERS (Aqu√≠ conectamos todo) ---

    // 1. Escuchar clics en la secci√≥n de fruter√≠a (para +,- y A√±adir)
    // (Usamos el 'id' del grid que pusimos en el HTML)
    document.getElementById('grid-fruteria').addEventListener('click', manejarClicFruteria);

    // 2. Escuchar clics en la lista del carrito para "Eliminar"
    listaCarrito.addEventListener('click', eliminarDelCarrito);

    // 3. Escuchar clic en el bot√≥n de "Enviar Pedido"
    btnEnviarWhatsApp.addEventListener('click', enviarPedidoWhatsApp);
    
    // 4. Escuchar cambios en el checkbox de factura
    checkFactura.addEventListener('change', toggleCamposFactura);

});


